<% content_for :app_title do %>
    <%= "Search Performance Explorer" %>
<% end %>

<div class="wrapper">
  <a name="top"></a>
  <div class="head-section">

    <div class="heading">
      <% if params["search_term"].blank? %>
        <h1 class="head-text">You did not enter a search term</h1>
      <% else %>
        <h1 class="head-text">You searched for</h1>
        <h2 class="search-term"><%= params["search_term"] %></h2>
      <% end %>
      <h2 class="results-text">These are your results</h2>
    </div>

    <div class="new-search">
      <h2 class="head-text">New Search</h2>
      <form id="homepage-form" action="/result" method="get">
        <div class="form-group">
          <label class="form-label" for="search_term_input">
            Search term to compare
          </label>
          <%= text_field_tag(:search_term, params[:search_term], class: "form-control") %>
        </div>

        <div class="form-group">
          <label class="form-label" for="result_count">
            Required number of results
          </label>
          <%= number_field_tag("count", "#{params["count"]}", class: "form-control", id: "result_count") %>
        </div>
        <input type="hidden" name="which_test" value="<%= params["which_test"] %>"/>
        <input class="button" id="search_button" type="submit" value="Search"></input>
      </form>
    </div>

  </div>
  <div class="grid-row">
    <% results = Searching.new(params).call %>
    <table class="results-table" >
      <tr class="table-row">
        <th></th>
        <th scope="col"><h3 class="heading-27" >A Results</h3></th>
        <th scope="col"><h3 class="heading-27" >B Results</h3></th>
        <th scope="col"><h3 class="heading-27" >Difference</h3></th>
      </tr>

      <% results.rows.each_with_index do |row, i| %>
        <tr class="table-row">
          <th >
            <p class="table-body table-column-with-padding">
              <%= "#{i + 1} -" %>
            </p>
          </th>

          <% row.each do |side| %>
            <th class="results-column">
              <p class="results-text" >

                <a href = "<%= side.link %>" >
                  <%= truncate(side.name, :length => 60 ) %>
                </a>

                <p><%= side['title'] %></p><br>

                <span class="head-info">
                  <% head_fields = Searching::HEAD_FIELDS.select { |field| enabled?(field) } %>
                  <%= side.get_head_info_list(head_fields).compact.join(", ") %>
                  <%=
                    render(
                      :partial => "content_id",
                      :locals => {
                        :side => side
                      }
                    )
                  %>
                  <% second_fields = Searching::SECONDARY_HEAD_FIELDS.select { |field| enabled?(field) } %>
                  <%=
                    render(
                      :partial => "people_and_organisations",
                      :locals => {
                        :side => side,
                        :fields => second_fields
                      }
                    )
                  %>
                </span>

                <br>
                <span class="head-info-2">
                  <%= truncate(side['description'], :length => 200) %>
                </span>


                <% enhanced_fields = Searching::ENHANCED_FIELDS.select { |field| enabled?(field) } %>
                <%=
                  render(
                    :partial => "enhanced_results_table",
                    :locals => {
                      :enhanced_results => side.enhanced_results(enhanced_fields)
                    }
                  )
                %>

              </p>
            </th>
          <% end %>

          <% score_difference = results.score_difference(results.right[i]['link'], i) %>
          <%=
            render(
              :partial => "up_down_box",
              :locals => {
                :score_difference => score_difference
              }
            )
          %>
        </tr>
      <% end %>

      <tr class="table-row">
        <th/>
        <th>
          <%= "#{results.left_total} results, #{results.left_missing} not shown" %>
        </th>
        <th>
          <%= "#{results.right_total} results, #{results.right_missing} not shown" %>
        </th>
        <th/>
      </tr>
    </table>
  </div>

  <a href="#top">Back to top</a>
</div>
